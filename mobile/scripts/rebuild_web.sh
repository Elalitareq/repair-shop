#!/usr/bin/env bash
set -euo pipefail

# Rebuilds the Flutter web artifacts and regenerates the web entrypoint.
# Usage: ./rebuild_web.sh

pushd "$(dirname "$0")/.." >/dev/null

echo "Cleaning Flutter build..."
flutter clean

echo "Getting packages..."
flutter pub get

# Ensure web is enabled
flutter config --enable-web || true

# Generate web artifacts
echo "Building web artifacts..."
flutter build web

echo "Checking for lib/main.dart and void main()..."
if [ ! -f "lib/main.dart" ]; then
  echo "Warning: lib/main.dart does not exist. Please ensure you have a main.dart in the lib/ directory."
else
  if ! grep -q "void main\(" lib/main.dart; then
    echo "Warning: lib/main.dart does not contain a 'void main()' entrypoint. Please add it."
  fi
fi

# Optional: provide the path to the generated web entrypoint (build artifacts)
BUILD_DIR="build/web"
if [ -d "$BUILD_DIR" ]; then
  echo "Web build produced the following files:" 
  ls -la "$BUILD_DIR"
else
  echo "Warning: $BUILD_DIR not found. If no errors occurred, this may be a subsequent build step generated by flutter tooling."
fi

popd >/dev/null

echo "Done. Web artifacts rebuilt."
